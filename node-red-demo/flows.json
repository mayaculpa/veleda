[{"id":"228a4406.83ae34","type":"tab","label":"Home","disabled":false,"info":""},{"id":"b3f3ed44.15c7f8","type":"tab","label":"Start Task","disabled":false,"info":""},{"id":"8f84f409.c922f8","type":"tab","label":"Add Peripheral","disabled":false,"info":""},{"id":"796edcc9.ca5e5c","type":"ui_group","z":"","name":"ControllerDetails","tab":"a62720e7.a2ef8","order":3,"disp":true,"width":"6","collapse":false},{"id":"ec6236d7.137cc8","type":"ui_group","z":"","name":"Sites","tab":"a62720e7.a2ef8","order":1,"disp":true,"width":"6","collapse":false},{"id":"cd0cc1f7.f893c","type":"ui_group","z":"","name":"Controllers","tab":"a62720e7.a2ef8","order":2,"disp":true,"width":"6","collapse":false},{"id":"91d9e90c.a5aca8","type":"ui_group","z":"","name":"PeripheralData","tab":"a62720e7.a2ef8","order":4,"disp":true,"width":"6","collapse":false},{"id":"be1649aa.e96398","type":"graphql-server","z":"","endpoint":"https://core.openfarming.ai/graphql/","name":"SDG Server Dev"},{"id":"a62720e7.a2ef8","type":"ui_tab","z":"","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"c4ee3a64.e099d","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"200bfae7.623226","type":"ui_group","z":"","name":"ControllerDetails","tab":"b03b140c.ca4658","order":3,"disp":true,"width":"6","collapse":false},{"id":"670e4df5.f9c974","type":"ui_group","z":"","name":"Sites","tab":"b03b140c.ca4658","order":1,"disp":true,"width":"6","collapse":false},{"id":"30aad13.8dbf32e","type":"ui_group","z":"","name":"Controllers","tab":"b03b140c.ca4658","order":2,"disp":true,"width":"6","collapse":false},{"id":"960b58bd.b1c8f","type":"ui_group","z":"","name":"PeripheralData","tab":"b03b140c.ca4658","order":4,"disp":true,"width":"6","collapse":false},{"id":"e82918af.83b928","type":"graphql-server","z":"","endpoint":"https://core.openfarming.ai/graphql/","name":"SDG Server Dev"},{"id":"b03b140c.ca4658","type":"ui_tab","z":"","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"71a59f71.d0148","type":"ui_group","z":"","name":"ControllerDetails","tab":"f7343b16.476a78","order":3,"disp":true,"width":"6","collapse":false},{"id":"98b42a7d.6e1ac","type":"ui_group","z":"","name":"Sites","tab":"f7343b16.476a78","order":1,"disp":true,"width":"6","collapse":false},{"id":"5a946829.faae5","type":"ui_group","z":"","name":"Controllers","tab":"f7343b16.476a78","order":2,"disp":true,"width":"6","collapse":false},{"id":"5745503.e4d52b","type":"ui_group","z":"","name":"PeripheralData","tab":"f7343b16.476a78","order":4,"disp":true,"width":"6","collapse":false},{"id":"7c0573ef.411e84","type":"graphql-server","z":"","endpoint":"https://core.openfarming.ai/graphql/","name":"SDG Server Dev"},{"id":"f7343b16.476a78","type":"ui_tab","z":"","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"7591ff8f.93ae9","type":"graphql-server","z":"","endpoint":"https://core.openfarming.ai/graphql/","name":"SDG Server Dev"},{"id":"ca06e8d2.9bd5d8","type":"ui_tab","z":"","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"1dc0f1bf.11676e","type":"ui_group","z":"","name":"Sites","tab":"ca06e8d2.9bd5d8","order":1,"disp":true,"width":"6","collapse":false},{"id":"31f4a618.39b33a","type":"ui_group","z":"","name":"Controllers","tab":"ca06e8d2.9bd5d8","order":2,"disp":true,"width":"6","collapse":false},{"id":"75be1027.4dcde","type":"ui_group","z":"","name":"ControllerDetails","tab":"ca06e8d2.9bd5d8","order":3,"disp":true,"width":"6","collapse":false},{"id":"4f5bcaf8.70ecd4","type":"ui_group","z":"","name":"PeripheralData","tab":"ca06e8d2.9bd5d8","order":4,"disp":true,"width":"6","collapse":false},{"id":"e799c4a2.b143a8","type":"ui_tab","z":"","name":"StartTask","icon":"dashboard","disabled":false,"hidden":false},{"id":"1b3eb2f8.827855","type":"ui_group","z":"","name":"SelectTask","tab":"e799c4a2.b143a8","order":1,"disp":true,"width":"6","collapse":false},{"id":"a3870993.68aec8","type":"ui_group","z":"","name":"PollSensor","tab":"e799c4a2.b143a8","order":2,"disp":true,"width":"6","collapse":false},{"id":"13943af0.22d85d","type":"ui_group","z":"","name":"SetValue","tab":"e799c4a2.b143a8","order":3,"disp":true,"width":"6","collapse":false},{"id":"ac54446e.090ca","type":"ui_tab","z":"","name":"AddPeripheral","icon":"dashboard","disabled":false,"hidden":false},{"id":"10830e1a.a2e112","type":"ui_group","z":"","name":"SelectPeripheralType","tab":"ac54446e.090ca","order":1,"disp":true,"width":"6","collapse":false},{"id":"49fdd85e.8fcd3","type":"ui_group","z":"","name":"DigitalIn","tab":"ac54446e.090ca","order":2,"disp":true,"width":"6","collapse":false},{"id":"4923e532.2ad494","type":"ui_group","z":"","name":"I2CAdapter","tab":"ac54446e.090ca","order":3,"disp":true,"width":"6","collapse":false},{"id":"ef6ddc9d.4d94e","type":"ui_group","z":"","name":"BME280","tab":"ac54446e.090ca","order":5,"disp":true,"width":"6","collapse":false},{"id":"2c52902d.e1ac68","type":"ui_group","z":"","name":"DigitalOut","tab":"ac54446e.090ca","order":5,"disp":true,"width":"6","collapse":false},{"id":"89c84b8c.3c997","type":"ui_group","z":"","name":"AnalogIn","tab":"ac54446e.090ca","order":6,"disp":true,"width":"6","collapse":false},{"id":"3585ca71.4c9306","type":"ui_group","z":"","name":"AnalogOut","tab":"ac54446e.090ca","order":7,"disp":true,"width":"6","collapse":false},{"id":"56dd7bf5.801f1c","type":"ui_group","z":"","name":"PWM","tab":"ac54446e.090ca","order":8,"disp":true,"width":"6","collapse":false},{"id":"d93004fa.aaab3","type":"function","z":"228a4406.83ae34","name":"to dropdown","func":"try {\n  if (msg.payload.allSites.edges.length > 0) {\n    msg = {\n      options: msg.payload.allSites.edges.map((edge) => ({\n        [edge.node.name]: edge.node.id,\n      })),\n    };\n  } else {\n    let empty_result = \"No sites found\";\n    msg = {\n      options: [empty_result],\n      payload: empty_result,\n    };\n  }\n} catch (error) {\n  let error_msg = \"Error requesting sites\";\n  msg = {\n    options: [error_msg],\n    payload: error_msg,\n  };\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":370,"y":200,"wires":[["8e8dae.2ea7a25"]]},{"id":"76aceda8.dbcf34","type":"function","z":"228a4406.83ae34","name":"to dropdown","func":"try {\n  if (msg.payload.allSiteEntities.edges.length > 0) {\n    msg = {\n      options: msg.payload.allSiteEntities.edges.map((edge) => ({\n        [edge.node.name]: edge.node.id,\n      })),\n    };\n  } else {\n    let empty_result = \"No controllers found\";\n    msg = {\n      options: [empty_result],\n      payload: empty_result,\n    };\n  }\n} catch (error) {\n  let error_msg = \"Error requesting controllers\";\n  msg = {\n    options: [error_msg],\n    payload: error_msg,\n  };\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":930,"y":200,"wires":[["2559bbda.a4c75c"]],"outputLabels":["controller SE"]},{"id":"1832603e.0edea8","type":"inject","z":"228a4406.83ae34","name":"","props":[],"repeat":"","crontab":"","once":true,"onceDelay":"1","topic":"","x":90,"y":200,"wires":[["44f8be60.df854"]]},{"id":"cefc8699.da525","type":"function","z":"228a4406.83ae34","name":"hide/show","func":"let have_controllers = false;\ntry{\n    have_controllers = Boolean(\n        msg.payload.allSiteEntities.edges\n    );\n} catch (error) {}\n\n\n\nmsg.payload = {\n    group: {\n        show: [],\n        hide: []\n    }\n};\nif (have_controllers) {\n    msg.payload.group.show.push(\"Home_Controllers\");\n} else {\n    msg.payload.group.hide.push(\"Home_Controllers\");\n}\nmsg.payload.group.hide.push(\"Home_PeripheralData\");\nmsg.payload.group.hide.push(\"Home_ControllerDetails\");\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":880,"y":260,"wires":[["787c6426.db2cd4"]]},{"id":"d835f016.d7ac8","type":"inject","z":"228a4406.83ae34","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"str","x":730,"y":260,"wires":[["cefc8699.da525"]]},{"id":"5c2be9d7.3066e","type":"function","z":"228a4406.83ae34","name":"to details","func":"let controller_msg = { payload: msg.payload.siteEntity.name };\n\nlet peripherals_msg = {};\ntry {\n  edges =\n    msg.payload.siteEntity.controllerComponent.peripheralComponentSet.edges;\n  if (edges.length > 0) {\n    peripherals_msg.options = edges.map((edge) => ({\n      [edge.node.siteEntity.name]: edge.node.siteEntity.id,\n    }));\n    peripherals_msg.peripherals = peripherals_msg[\"options\"];\n  } else {\n    let empty_results = \"No peripherals found\";\n    peripherals_msg.options = [empty_results];\n    peripherals_msg.payload = empty_results;\n    peripherals_msg.peripherals = [];\n  }\n} catch (error) {\n  let error_msg = \"Error requesting peripherals\";\n  peripherals_msg.options = [error_msg];\n  peripherals_msg.payload = error_msg;\n  peripherals_msg.peripherals = [];\n}\n\nlet start_task_msg = { enabled: false };\n\nreturn [controller_msg, peripherals_msg, start_task_msg];\n","outputs":3,"noerr":0,"initialize":"","finalize":"","x":1500,"y":200,"wires":[["f3f66593.0a7aa","d2a6c8d0.5ab36"],["bc7f03b.b42468","fae38638.92eb6"],["932c1a8d.93916"]],"outputLabels":["controller SE","",""]},{"id":"9052ff60.cbba28","type":"delay","z":"228a4406.83ae34","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":835,"y":200,"wires":[["76aceda8.dbcf34"]],"l":false},{"id":"27004015.4f7b28","type":"function","z":"228a4406.83ae34","name":"show","func":"return {payload: {group: {show: [\"Home_ControllerDetails\"], hide: [\"Home_PeripheralData\"]}}};","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1450,"y":420,"wires":[["ac5a7e15.1a2b4"]]},{"id":"4645e122.b0fc9","type":"delay","z":"228a4406.83ae34","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1415,"y":200,"wires":[["5c2be9d7.3066e"]],"l":false},{"id":"25286d9b.0aba2a","type":"change","z":"228a4406.83ae34","name":"enable","rules":[{"t":"set","p":"enabled","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1510,"y":300,"wires":[["932c1a8d.93916"]]},{"id":"2d5a2d2f.815d1a","type":"ui_button","z":"228a4406.83ae34","name":"","group":"75be1027.4dcde","order":5,"width":0,"height":0,"passthru":false,"label":"Add peripheral","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":1680,"y":380,"wires":[["19a2470a.eea3c9","b2fecc9.0bbf43"]]},{"id":"932c1a8d.93916","type":"ui_button","z":"228a4406.83ae34","name":"","group":"75be1027.4dcde","order":4,"width":0,"height":0,"passthru":false,"label":"Start task","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"startTask","x":1660,"y":300,"wires":[["fae38638.92eb6","aedfd241.42b1e8"]]},{"id":"8e8dae.2ea7a25","type":"ui_dropdown","z":"228a4406.83ae34","name":"sites","label":"","tooltip":"","place":"Select option","group":"1dc0f1bf.11676e","order":1,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":510,"y":200,"wires":[["a32ef9e3.8a549","4e6a3a5f.360d44"]]},{"id":"2559bbda.a4c75c","type":"ui_dropdown","z":"228a4406.83ae34","name":"controllers","label":"","tooltip":"","place":"Select controller","group":"31f4a618.39b33a","order":0,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1090,"y":200,"wires":[["ac62235d.207958","a948ca75.841ae8"]]},{"id":"bc7f03b.b42468","type":"ui_dropdown","z":"228a4406.83ae34","name":"peripherals","label":"","tooltip":"","place":"Connected Peripherals","group":"75be1027.4dcde","order":3,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1670,"y":200,"wires":[["25286d9b.0aba2a","fae38638.92eb6","eb0a6d47.53ae08","3843decf.7af05a","7372edca.e28204"]]},{"id":"f3f66593.0a7aa","type":"ui_text","z":"228a4406.83ae34","group":"75be1027.4dcde","order":1,"width":0,"height":0,"name":"","label":"Name","format":"{{msg.payload}}","layout":"row-left","x":1650,"y":160,"wires":[]},{"id":"143d7e96.158e59","type":"ui_chart","z":"228a4406.83ae34","name":"","group":"4f5bcaf8.70ecd4","order":0,"width":0,"height":0,"label":"{{msg.label}}","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"100","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"outputs":1,"x":3050,"y":200,"wires":[[]]},{"id":"787c6426.db2cd4","type":"ui_ui_control","z":"228a4406.83ae34","name":"","events":"all","x":1020,"y":260,"wires":[[]]},{"id":"ac5a7e15.1a2b4","type":"ui_ui_control","z":"228a4406.83ae34","name":"","events":"all","x":1580,"y":420,"wires":[[]]},{"id":"44f8be60.df854","type":"graphql","z":"228a4406.83ae34","name":"all sites","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"plain","template":"{allSites{edges{node{id,name}}}}","x":220,"y":200,"wires":[["d93004fa.aaab3"],["d93004fa.aaab3"]],"icon":"font-awesome/fa-search"},{"id":"a32ef9e3.8a549","type":"graphql","z":"228a4406.83ae34","name":"all controller SEs","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"mustache","template":"{\n  allSiteEntities(site: \"{{payload}}\", isController: true) {\n    edges{\n      node{\n        id,\n        name,\n        controllerComponent{\n          id\n        }\n      }\n    }\n  }\n}","x":690,"y":200,"wires":[["cefc8699.da525","9052ff60.cbba28"],["9052ff60.cbba28"]],"icon":"font-awesome/fa-search"},{"id":"ac62235d.207958","type":"graphql","z":"228a4406.83ae34","name":"controller details","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"mustache","template":"{\n  siteEntity(id: \"{{payload}}\") {\n    name,\n    controllerComponent {\n      createdAt,\n      peripheralComponentSet{\n        edges{\n          node{\n            siteEntity{id, name}\n          }\n        }\n      }\n    }\n  }\n}","x":1280,"y":200,"wires":[["27004015.4f7b28","4645e122.b0fc9"],["4645e122.b0fc9"]],"icon":"font-awesome/fa-search"},{"id":"ff1fae0b.7853f","type":"link in","z":"b3f3ed44.15c7f8","name":"peripheral","links":["8b342833.b60fa"],"x":135,"y":200,"wires":[["75c7e662.564fe8","a79e3a24.732318","1735ac52.19167c"]]},{"id":"a2f5e791.2a5d78","type":"ui_dropdown","z":"b3f3ed44.15c7f8","name":"","label":"","tooltip":"","place":"Select option","group":"1b3eb2f8.827855","order":4,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":620,"y":260,"wires":[["cd3186fc.8f5978","cf41dd5f.fad06"]]},{"id":"a79e3a24.732318","type":"graphql","z":"b3f3ed44.15c7f8","name":"getTaskTypes","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"mustache","template":"{\n  controllerTaskEnums{\n    taskTypes {\n      value\n      label\n    }\n   }\n  siteEntity(id: \"{{payload.peripheralGID}}\") {\n    name\n    peripheralComponent{\n      peripheralType\n      state\n      controllerComponent{id}\n      dataPointTypeSet{\n        edges{\n          node{\n            name\n            unit\n            id\n          }\n        }\n      }\n    }\n  }\n}","x":280,"y":260,"wires":[["e883aa4.c20dbd8","99d35b61.83cd6"],[]]},{"id":"e883aa4.c20dbd8","type":"function","z":"b3f3ed44.15c7f8","name":"to dropdown","func":"let options = msg.payload.controllerTaskEnums.taskTypes.map(\n    (taskType) => ({[taskType.label]: taskType.value})\n);\nreturn {options: options};\n\n\n\nlet values = msg.payload.controllerTaskEnums.taskTypeValues;\nlet labels = msg.payload.controllerTaskEnums.taskTypeLabels;\n\nfor(let i = 0; i < values.length; i++) {\n    let option = {};\n    option[labels[i]] = values[i];\n    options.push(option);\n}\nreturn {\"options\": options};","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":260,"wires":[["a2f5e791.2a5d78"]]},{"id":"fae38638.92eb6","type":"function","z":"228a4406.83ae34","name":"set peripheral","func":"if (msg.peripherals) {\n  // peripherals has the format [{peripheralName: peripheralGID}]\n  context.set(\"peripherals\", msg.peripherals);\n} else if (msg.topic === \"startTask\") {\n  let peripherals = context.get(\"peripherals\");\n  let selectedPeripheral = context.get(\"peripheral\");\n  let peripheral = peripherals.find(\n    (peripheral) => Object.values(peripheral)[0] === selectedPeripheral\n  );\n  msg.payload = {\n      peripheralGID: Object.values(peripheral)[0],\n      peripheralName: Object.keys(peripheral)[0],\n      controllerName: flow.get(\"controllerName\")\n  };\n  return msg;\n} else {\n  // peripheral has the format {peripheralName: peripheralGID}\n  context.set(\"peripheral\", msg.payload);\n  return null;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1880,"y":300,"wires":[["8b342833.b60fa"]]},{"id":"8b342833.b60fa","type":"link out","z":"228a4406.83ae34","name":"","links":["ff1fae0b.7853f"],"x":1995,"y":300,"wires":[]},{"id":"75c7e662.564fe8","type":"function","z":"b3f3ed44.15c7f8","name":"set peripheral","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nflow.set(\"peripheral\", msg.payload)\n\nreturn {payload: msg.payload.peripheralName};","outputs":1,"noerr":0,"initialize":"","finalize":"","x":280,"y":140,"wires":[["f4c6833d.af62c"]]},{"id":"f4c6833d.af62c","type":"ui_text","z":"b3f3ed44.15c7f8","group":"1b3eb2f8.827855","order":2,"width":0,"height":0,"name":"","label":"Peripheral:","format":"{{msg.payload}}","layout":"row-spread","x":450,"y":140,"wires":[]},{"id":"aedfd241.42b1e8","type":"function","z":"228a4406.83ae34","name":"goto tab","func":"return {payload: {tab: \"StartTask\"}};","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1860,"y":340,"wires":[["5d1987ed.ef1068"]]},{"id":"5d1987ed.ef1068","type":"ui_ui_control","z":"228a4406.83ae34","name":"","events":"all","x":2020,"y":360,"wires":[[]]},{"id":"cd3186fc.8f5978","type":"function","z":"b3f3ed44.15c7f8","name":"show form group","func":"let taskTypes = flow.get(\"taskTypes\");\nhideGroups = taskTypes\n  .filter(taskType => taskType.value != msg.payload)\n  .map((taskType) => \"StartTask_\".concat(taskType.value));\nshowGroup = \"StartTask_\".concat(msg.payload);\n\nreturn {payload: {group: {show: showGroup , hide: hideGroups}}};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":810,"y":260,"wires":[["96804692.ad2498","273a7bd8.3039d4"]]},{"id":"76918725.0eeb48","type":"ui_form","z":"b3f3ed44.15c7f8","name":"Start set value","label":"","group":"13943af0.22d85d","order":0,"width":0,"height":0,"options":[{"label":"Value","value":"value","type":"number","required":true,"rows":null}],"formValue":{"value":""},"payload":"","submit":"submit","cancel":"cancel","topic":"","x":1080,"y":340,"wires":[["1bc1ccb1.c32f33"]]},{"id":"28105580.d27a1a","type":"ui_form","z":"b3f3ed44.15c7f8","name":"Start poll sensor","label":"","group":"a3870993.68aec8","order":0,"width":0,"height":0,"options":[{"label":"Inverval in s","value":"interval_s","type":"number","required":true,"rows":null},{"label":"Duration in s (forever if 0)","value":"duration_s","type":"number","required":false,"rows":null}],"formValue":{"interval_s":"","duration_s":""},"payload":"","submit":"submit","cancel":"cancel","topic":"","x":1080,"y":440,"wires":[["2e957d4f.5c771a"]]},{"id":"1bc1ccb1.c32f33","type":"function","z":"b3f3ed44.15c7f8","name":"start task","func":"parameters = {};\n// Set the peripheral UUID\nconst peripheralGID = new Buffer(\n  flow.get(\"peripheral\").peripheralGID,\n  \"base64\"\n);\nparameters[\"peripheral\"] = peripheralGID.toString().split(\":\")[1];\n// Set the data point type UUID\nconst dataPointTypeGID = new Buffer.from(\n  flow.get(\"setValueDataPointTypeGID\"),\n  \"base64\"\n).toString();\nparameters[\"data_point_type\"] = dataPointTypeGID.split(\":\")[1];\n// Set the value\nparameters[\"value\"] = msg.payload.value;\n\nreturn {\n  variables: {\n    input: {\n      controllerComponent: flow.get(\"controllerComponentGID\"),\n      taskType: flow.get(\"taskType\"),\n      parameters: JSON.stringify(parameters),\n    },\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1500,"y":340,"wires":[["ff77b3e1.054d8"]]},{"id":"b33f7df6.720608","type":"function","z":"b3f3ed44.15c7f8","name":"set controllerComponentGID","func":"try {\n    flow.set(\"controllerComponentGID\", msg.payload.siteEntity.peripheralComponent.controllerComponent.id);\n} catch(err) {\n    flow.set(\"controllerComponentGID\", null);\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":700,"y":180,"wires":[["cbc2bc1e.45316"]]},{"id":"cf41dd5f.fad06","type":"function","z":"b3f3ed44.15c7f8","name":"set taskType","func":"flow.set(\"taskType\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":790,"y":220,"wires":[]},{"id":"ff77b3e1.054d8","type":"graphql","z":"b3f3ed44.15c7f8","name":"start controller task","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"plain","template":"mutation startControllerTask($input: StartControllerTaskInput!) {\n  startControllerTask(input: $input) {\n    controllerTask{\n      id\n      controllerComponent {id}\n      taskType\n      state\n      parameters\n      runUntil\n    }\n  }\n}","x":1730,"y":340,"wires":[["921fe7e1.0e6ce"],["921fe7e1.0e6ce"]]},{"id":"809832c7.0dd0a8","type":"ui_toast","z":"b3f3ed44.15c7f8","position":"top right","displayTime":"3","highlight":"","sendall":true,"outputs":0,"ok":"OK","cancel":"","raw":false,"topic":"","name":"","x":2080,"y":340,"wires":[]},{"id":"921fe7e1.0e6ce","type":"function","z":"b3f3ed44.15c7f8","name":"to notification","func":"if(msg.payload.error){\n    return {payload: msg.payload.error};\n}\ntry {\n    return {\n        payload: `Successfully starting ${msg.payload.startControllerTask.controllerTask.taskType} task`\n    };\n} catch(error) {\n    return {payload: \"Unable to start controller task\"};\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1910,"y":340,"wires":[["809832c7.0dd0a8"]]},{"id":"adebc3ea.5c715","type":"link in","z":"8f84f409.c922f8","name":"peripheral","links":["80c025dd.50c4e"],"x":35,"y":300,"wires":[["9af911b.3eaa07","37fb3ee8.c18fea","c795a61b.aa92d"]]},{"id":"b2fecc9.0bbf43","type":"function","z":"228a4406.83ae34","name":"get controller and site","func":"return {\n  payload: {\n    SEControllerGID: flow.get(\"SEControllerGID\"),\n    siteGID: flow.get(\"siteGID\"),\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1900,"y":420,"wires":[["80c025dd.50c4e"]]},{"id":"80c025dd.50c4e","type":"link out","z":"228a4406.83ae34","name":"","links":["adebc3ea.5c715"],"x":2035,"y":420,"wires":[]},{"id":"19a2470a.eea3c9","type":"function","z":"228a4406.83ae34","name":"goto tab","func":"return {payload: {tab: \"AddPeripheral\"}};","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1860,"y":380,"wires":[["5d1987ed.ef1068"]]},{"id":"a948ca75.841ae8","type":"function","z":"228a4406.83ae34","name":"set SEControllerGID","func":"flow.set(\"SEControllerGID\", msg.payload);","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1300,"y":160,"wires":[]},{"id":"9af911b.3eaa07","type":"debug","z":"8f84f409.c922f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":170,"y":360,"wires":[]},{"id":"37fb3ee8.c18fea","type":"graphql","z":"8f84f409.c922f8","name":"getPeripheralTypes","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"mustache","template":"{\n  peripheralComponentEnums{\n    peripheralTypes {\n      value\n      label\n    }\n  }\n  allDataPointTypes{\n    edges{\n      node{\n        id\n        name\n        unit\n      }\n    }\n  }\n  siteEntity(id: \"{{payload.SEControllerGID}}\") {\n    controllerComponent{\n      id\n    }\n  }\n}","x":190,"y":300,"wires":[["cbdf709.fbe521","7ebd9e8a.8c35b","33cb2094.6c72d8","2f483bda.9d3e44"],[]]},{"id":"c2b17819.b1165","type":"ui_dropdown","z":"8f84f409.c922f8","name":"","label":"","tooltip":"","place":"Select option","group":"10830e1a.a2e112","order":1,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":580,"y":300,"wires":[["2b4b63aa.81d65c","32ba3e4a.c326d2"]]},{"id":"cbdf709.fbe521","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\noptions = msg.payload.peripheralComponentEnums.peripheralTypes\n  .sort((peripheralA, peripheralB) =>\n    peripheralA.label.localeCompare(peripheralB.label)\n  )\n  .map((peripheralType) => ({ [peripheralType.label]: peripheralType.value }));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":390,"y":300,"wires":[["c2b17819.b1165"]]},{"id":"1f832d48.68d783","type":"ui_button","z":"b3f3ed44.15c7f8","name":"back","group":"1b3eb2f8.827855","order":5,"width":0,"height":0,"passthru":false,"label":"Back","tooltip":"","color":"","bgcolor":"gray","icon":"","payload":"{\"tab\":\"Home\"}","payloadType":"json","topic":"","x":250,"y":100,"wires":[["8dfa4216.3d3e4"]]},{"id":"8dfa4216.3d3e4","type":"ui_ui_control","z":"b3f3ed44.15c7f8","name":"","events":"all","x":380,"y":100,"wires":[[]]},{"id":"120dde21.23ff4a","type":"ui_button","z":"8f84f409.c922f8","name":"back","group":"10830e1a.a2e112","order":2,"width":0,"height":0,"passthru":false,"label":"Back","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"tab\":\"Home\"}","payloadType":"json","topic":"","x":150,"y":180,"wires":[["9ac3f7e5.dd6ae8"]]},{"id":"9ac3f7e5.dd6ae8","type":"ui_ui_control","z":"8f84f409.c922f8","name":"","events":"all","x":280,"y":180,"wires":[[]]},{"id":"99d35b61.83cd6","type":"function","z":"b3f3ed44.15c7f8","name":"set taskTypes","func":"flow.set(\"taskTypes\", msg.payload.controllerTaskEnums.taskTypes);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":480,"y":180,"wires":[["b33f7df6.720608"]]},{"id":"f1bd403d.1ea2e8","type":"function","z":"b3f3ed44.15c7f8","name":"hide form groups","func":"let taskFormGroups = msg.payload.controllerTaskEnums.taskTypes.map(\n    (taskType) => \"StartTask_\".concat(taskType.value)\n);\nreturn {payload: {group: {hide: taskFormGroups}}};","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1130,"y":180,"wires":[["89ccdde6.3ee2a"]]},{"id":"89ccdde6.3ee2a","type":"ui_ui_control","z":"b3f3ed44.15c7f8","name":"","events":"all","x":1300,"y":180,"wires":[[]]},{"id":"b6d2d279.6ca658","type":"comment","z":"b3f3ed44.15c7f8","name":"Additional task types can be added here...","info":"","x":1160,"y":500,"wires":[]},{"id":"2b4b63aa.81d65c","type":"function","z":"8f84f409.c922f8","name":"set peripheralType","func":"flow.set(\"peripheralType\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":770,"y":260,"wires":[]},{"id":"32ba3e4a.c326d2","type":"function","z":"8f84f409.c922f8","name":"show form group","func":"let peripheralTypes = flow.get(\"peripheralTypes\");\nhideGroups = peripheralTypes\n  .filter((peripheralType) => peripheralType.value != msg.payload)\n  .map((peripheralType) => \"AddPeripheral_\".concat(peripheralType.value));\nshowGroup = \"AddPeripheral_\".concat(msg.payload);\n\nreturn { payload: { group: { show: showGroup, hide: hideGroups } } };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":770,"y":300,"wires":[["5293786b.c0404","34d1348f.56e24c"]]},{"id":"5293786b.c0404","type":"ui_ui_control","z":"8f84f409.c922f8","name":"","events":"all","x":960,"y":260,"wires":[[]]},{"id":"7ebd9e8a.8c35b","type":"function","z":"8f84f409.c922f8","name":"set peripheralTypes","func":"flow.set(\"peripheralTypes\", msg.payload.peripheralComponentEnums.peripheralTypes);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":220,"wires":[["bc06d996.741118"]]},{"id":"2fd3c16.9c0973e","type":"function","z":"8f84f409.c922f8","name":"hide form groups","func":"let peripheralFormGroups = msg.payload.peripheralComponentEnums.peripheralTypes.map(\n    (peripheralType) => \"AddPeripheral_\".concat(peripheralType.value)\n);\nreturn {payload: {group: {hide: peripheralFormGroups}}};","outputs":1,"noerr":0,"initialize":"","finalize":"","x":870,"y":220,"wires":[["4281e877.bade8"]]},{"id":"4281e877.bade8","type":"ui_ui_control","z":"8f84f409.c922f8","name":"","events":"all","x":1040,"y":220,"wires":[[]]},{"id":"33cb2094.6c72d8","type":"debug","z":"8f84f409.c922f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":390,"y":260,"wires":[]},{"id":"2f483bda.9d3e44","type":"function","z":"8f84f409.c922f8","name":"set dataPointTypes","func":"let dataPointTypes = [];\ntry {\n  dataPointTypes = msg.payload.allDataPointTypes.edges\n    .map((edge) => edge.node)\n    .sort((dptA, dptB) => dptA.name.localeCompare(dptB.name));\n} catch (err) {\n  dataPointTypes = [{ name: \"None\", unit: \"N/A\", id: \"\" }];\n}\nflow.set(\"dataPointTypes\", dataPointTypes);\nreturn { payload: dataPointTypes };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":410,"y":360,"wires":[[]]},{"id":"36d3c3a4.5bb104","type":"graphql","z":"8f84f409.c922f8","name":"add peripheral","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"mustache","template":"mutation createPeripheralComponent($input: CreatePeripheralComponentInput!) {\n  createPeripheralComponent(input: $input) {\n    peripheralComponent {\n      id\n      siteEntity {\n        id\n        name\n      }\n      controllerComponent {\n        id\n      }\n      peripheralType\n      state\n      parameters\n    }\n  }\n}\n","x":1940,"y":1020,"wires":[["4ad850ec.603e5"],["4ad850ec.603e5"]]},{"id":"b28c08a1.a70f1","type":"ui_toast","z":"8f84f409.c922f8","position":"top right","displayTime":"3","highlight":"","sendall":true,"outputs":0,"ok":"OK","cancel":"","raw":false,"topic":"","name":"","x":2280,"y":1020,"wires":[]},{"id":"4ad850ec.603e5","type":"function","z":"8f84f409.c922f8","name":"to notification","func":"if(msg.payload.error){\n    return {payload: msg.payload.error};\n}\ntry {\n    return {\n        payload: `Adding ${msg.payload.createPeripheralComponent.peripheralComponent.siteEntity.name} peripheral`\n    };\n} catch(error) {\n    return {payload: \"Unable to create peripheral\"};\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2110,"y":1020,"wires":[["b28c08a1.a70f1"]]},{"id":"cbb7dbf5.49c04","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Digital In DPT","label":"","tooltip":"","place":"Select on/off type","group":"49fdd85e.8fcd3","order":1,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1220,"y":340,"wires":[["17ac5f0d.d1a299"]]},{"id":"17ac5f0d.d1a299","type":"function","z":"8f84f409.c922f8","name":"set digitalInDataPointTypeGID","func":"flow.set(\"digitalInDataPointTypeGID\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1450,"y":340,"wires":[]},{"id":"4c991ec7.e8749","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":340,"wires":[["cbb7dbf5.49c04"]]},{"id":"cff6ef72.2544d","type":"ui_form","z":"8f84f409.c922f8","name":"Parameters","label":"","group":"49fdd85e.8fcd3","order":3,"width":0,"height":0,"options":[{"label":"Name","value":"name","type":"text","required":true,"rows":null},{"label":"Pin #","value":"pin","type":"number","required":true,"rows":null}],"formValue":{"name":"","pin":""},"payload":"","submit":"create","cancel":"clear","topic":"","x":1050,"y":420,"wires":[["1c6f918a.141306"]]},{"id":"1c6f918a.141306","type":"function","z":"8f84f409.c922f8","name":"add digital in peripheral","func":"// Other parameters have to use snake case\nlet otherParameters = {\n  pin: msg.payload.pin,\n  input_type: flow.get(\"digitalInInputType\")\n};\n\nlet siteGID = flow.get(\"siteGID\");\nlet controllerComponentGID = flow.get(\"controllerComponentGID\");\nlet digitalInDataPointTypeGID = flow.get(\"digitalInDataPointTypeGID\");\n\nreturn {\n  variables: {\n    input: {\n      name: msg.payload.name,\n      site: siteGID,\n      controllerComponent: controllerComponentGID,\n      peripheralType: \"DigitalIn\",\n      otherParameters: JSON.stringify(otherParameters),\n      dataPointTypeEdges: [\n        {\n          dataPointType: digitalInDataPointTypeGID,\n          parameterPrefix: \"\",\n        },\n      ],\n    },\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":420,"wires":[["36d3c3a4.5bb104"]]},{"id":"91373aab.e5355","type":"comment","z":"8f84f409.c922f8","name":"Additional peripheral types can be added here...","info":"","x":1160,"y":1380,"wires":[]},{"id":"bc06d996.741118","type":"function","z":"8f84f409.c922f8","name":"set controllerComponentGID","func":"try {\n    flow.set(\"controllerComponentGID\", msg.payload.siteEntity.controllerComponent.id);\n} catch(err) {\n    flow.set(\"controllerComponentGID\", \"\");\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":640,"y":220,"wires":[["2fd3c16.9c0973e"]]},{"id":"4e6a3a5f.360d44","type":"function","z":"228a4406.83ae34","name":"set siteGID","func":"flow.set(\"siteGID\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":670,"y":160,"wires":[[]]},{"id":"c795a61b.aa92d","type":"function","z":"8f84f409.c922f8","name":"set siteGID","func":"try {\n    flow.set(\"siteGID\", msg.payload.siteGID);\n} catch(err) {\n    flow.set(\"siteGID\", \"\");\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":170,"y":260,"wires":[[]]},{"id":"1e88a981.74821e","type":"ui_dropdown","z":"228a4406.83ae34","name":"data point types","label":"","tooltip":"","place":"Select data point type","group":"4f5bcaf8.70ecd4","order":1,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":2360,"y":140,"wires":[["d7f12c09.0f2268","b8da90bb.597d98","88c29a3e.ae713"]]},{"id":"4a38a330.9767f4","type":"graphql","z":"228a4406.83ae34","name":"data points","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"mustache","template":"query {\n  allDataPoints(peripheralComponent_SiteEntity: \"{{siteEntity}}\", dataPointType: \"{{dataPointType}}\", last: 100){\n    edges{\n      node{\n        time\n        value\n      }\n    }\n  }\n}","x":2730,"y":140,"wires":[["b11ab4fe.f18ea"],["b11ab4fe.f18ea"]],"icon":"font-awesome/fa-search"},{"id":"eb0a6d47.53ae08","type":"graphql","z":"228a4406.83ae34","name":"data point types","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"mustache","template":"{\n  allDataPointTypes(peripheralComponentSet_SiteEntity: \"{{payload}}\"){\n    edges{\n      node{\n        id\n        name\n        unit\n      }\n    }\n  }\n  siteEntity(id: \"{{payload}}\") {\n    name\n    peripheralComponent {\n      peripheralType\n      state\n      otherParameters\n      createdAt\n      modifiedAt\n    }    \n  }\n}","x":1880,"y":140,"wires":[["46dfea14.1e9bc4","c82e1c85.ff112","dac5ce5b.efd7c"],["46dfea14.1e9bc4"]],"icon":"font-awesome/fa-search"},{"id":"46dfea14.1e9bc4","type":"function","z":"228a4406.83ae34","name":"to dropdown","func":"let controller_msg = {};\ntry {\n  let options = msg.payload.allDataPointTypes.edges.map((edge) => ({\n    [`${edge.node.name} in ${edge.node.unit}`]: edge.node.id,\n  }));\n  controller_msg[\"options\"] = options;\n} catch (error) {\n  controller_msg[\"options\"] = \"Request failed\";\n}\n\nreturn controller_msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2170,"y":140,"wires":[["1e88a981.74821e","7063e7f9.b86db8"]],"outputLabels":["controller SE"]},{"id":"3843decf.7af05a","type":"function","z":"228a4406.83ae34","name":"show","func":"return {payload: {group: {show: [\"Home_PeripheralData\"]}}};","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1850,"y":260,"wires":[["f4a643cf.df9878"]]},{"id":"f4a643cf.df9878","type":"ui_ui_control","z":"228a4406.83ae34","name":"","events":"all","x":1980,"y":260,"wires":[[]]},{"id":"6288a1fc.cca9a8","type":"ui_text","z":"b3f3ed44.15c7f8","group":"1b3eb2f8.827855","order":3,"width":0,"height":0,"name":"","label":"Use poll sensor or set value","format":"","layout":"row-spread","x":320,"y":320,"wires":[]},{"id":"d7f12c09.0f2268","type":"function","z":"228a4406.83ae34","name":"get data points","func":"return {\n  siteEntity: flow.get(\"SEPeripheralGID\"),\n  dataPointType: msg.payload,\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2560,"y":140,"wires":[["4a38a330.9767f4"]]},{"id":"7372edca.e28204","type":"function","z":"228a4406.83ae34","name":"set SEPeripheralGID","func":"flow.set(\"SEPeripheralGID\", msg.payload);","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1900,"y":200,"wires":[]},{"id":"b11ab4fe.f18ea","type":"function","z":"228a4406.83ae34","name":"to chart","func":"let dataPointType = flow.get(\"dataPointType\");\nlet dataPoints = msg.payload.allDataPoints.edges.map((edge) =>\n    ({x: edge.node.time, y: edge.node.value})\n);\nif(dataPoints.length > 0) {\n    msg = {\n        payload: [{\n            series: [dataPointType.id],\n            data: [\n                dataPoints\n            ],\n            labels: [\"\"]\n        }],\n        label: \"Data Points\"\n    };\n} else {\n    msg = {\n        payload: [],\n        label: \"No Data\"\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2900,"y":140,"wires":[["143d7e96.158e59"]]},{"id":"b8da90bb.597d98","type":"function","z":"228a4406.83ae34","name":"set dataPointType","func":"let dataPointTypes = flow.get(\"dataPointTypes\");\nflow.set(\"dataPointType\", dataPointTypes.find((dataPointType) => dataPointType.id === msg.payload));","outputs":0,"noerr":0,"initialize":"","finalize":"","x":2570,"y":100,"wires":[]},{"id":"88c29a3e.ae713","type":"function","z":"228a4406.83ae34","name":"clear graph","func":"return { payload: [], label: \"No Data\"};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2550,"y":200,"wires":[["143d7e96.158e59"]]},{"id":"7063e7f9.b86db8","type":"delay","z":"228a4406.83ae34","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2295,"y":200,"wires":[["88c29a3e.ae713"]],"l":false},{"id":"c82e1c85.ff112","type":"function","z":"228a4406.83ae34","name":"set dataPointTypes","func":"try {\n  flow.set(\"dataPointTypes\", msg.payload.allDataPointTypes.edges.map((edge) => edge.node));\n} catch (error) {\n  flow.set(\"dataPointTypes\", [])\n}","outputs":0,"noerr":0,"initialize":"","finalize":"","x":2190,"y":100,"wires":[]},{"id":"4f805257.a1ef54","type":"ui_button","z":"228a4406.83ae34","name":"Retry","group":"1dc0f1bf.11676e","order":4,"width":"3","height":"1","passthru":false,"label":"Reconnect","tooltip":"","color":"","bgcolor":"gray","icon":"","payload":"","payloadType":"str","topic":"","x":80,"y":160,"wires":[["44f8be60.df854"]]},{"id":"c81a1169.c481f8","type":"ui_text","z":"228a4406.83ae34","group":"1dc0f1bf.11676e","order":2,"width":"3","height":"1","name":"Server code link","label":"<a href=\"https://github.com/protohaus/sdg-server/tree/update-farm-app\" target=”_blank\">Server Code</a>","format":"","layout":"row-spread","x":240,"y":260,"wires":[]},{"id":"be3e0473.83b2c8","type":"ui_text","z":"228a4406.83ae34","group":"1dc0f1bf.11676e","order":3,"width":"3","height":"1","name":"Controller code link","label":"<a href=\"https://github.com/protohaus/sdg-controller/tree/Unstable\" target=”_blank\">Controller Code</a>","format":"","layout":"row-spread","x":250,"y":300,"wires":[]},{"id":"c4f768e1.b02858","type":"ui_text","z":"228a4406.83ae34","group":"1dc0f1bf.11676e","order":3,"width":"3","height":"1","name":"Contact link","label":"<a href=\"mailto:moritz.ulmer@posteo.de\">Contact</a>","format":"","layout":"row-spread","x":230,"y":340,"wires":[]},{"id":"3c9b3171.568eb6","type":"comment","z":"8f84f409.c922f8","name":"Add DigitalIn peripheral","info":"","x":1080,"y":300,"wires":[]},{"id":"969c2f6.283265","type":"comment","z":"8f84f409.c922f8","name":"Add I2C adapter","info":"","x":1060,"y":1020,"wires":[]},{"id":"6dc33b0.823ffc4","type":"ui_form","z":"8f84f409.c922f8","name":"Parameters","label":"","group":"4923e532.2ad494","order":1,"width":0,"height":0,"options":[{"label":"Name","value":"name","type":"text","required":true,"rows":null},{"label":"SCL pin #","value":"scl","type":"number","required":true,"rows":null},{"label":"SDA pin #","value":"sda","type":"number","required":true,"rows":null}],"formValue":{"name":"","scl":"","sda":""},"payload":"","submit":"submit","cancel":"cancel","topic":"","x":1050,"y":1060,"wires":[["84e69843.5e0198"]]},{"id":"84e69843.5e0198","type":"function","z":"8f84f409.c922f8","name":"add I2C adapter","func":"let otherParameters = {\n  scl: msg.payload.scl,\n  sda: msg.payload.sda\n};\n\nlet siteGID = flow.get(\"siteGID\");\nlet controllerComponentGID = flow.get(\"controllerComponentGID\");\nlet LEDDataPointTypeGID = flow.get(\"LEDDataPointTypeGID\");\n\nreturn {\n  variables: {\n    input: {\n      name: msg.payload.name,\n      site: siteGID,\n      controllerComponent: controllerComponentGID,\n      peripheralType: \"I2CAdapter\",\n      otherParameters: JSON.stringify(otherParameters),\n    },\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1740,"y":1060,"wires":[["36d3c3a4.5bb104"]]},{"id":"b2519c5c.591c38","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Temperature DPT","label":"temperature","tooltip":"","place":"Select type","group":"ef6ddc9d.4d94e","order":2,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1230,"y":1140,"wires":[["e67996f.f3cb068"]]},{"id":"e67996f.f3cb068","type":"function","z":"8f84f409.c922f8","name":"set temperature","func":"flow.set(\"BME280TemperatureDataPointTypeGID\", msg.payload);\n","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1420,"y":1140,"wires":[]},{"id":"8cc5faa0.2c7a2","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":1140,"wires":[["b2519c5c.591c38"]]},{"id":"2617decc.09f6aa","type":"comment","z":"8f84f409.c922f8","name":"Add BME/P280 peripheral","info":"","x":1090,"y":1100,"wires":[]},{"id":"a77d1cff.9692d8","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Humidity DPT","label":"humidity","tooltip":"","place":"Select type","group":"ef6ddc9d.4d94e","order":4,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1220,"y":1220,"wires":[["e888b07a.5bf818"]]},{"id":"e888b07a.5bf818","type":"function","z":"8f84f409.c922f8","name":"set humidity","func":"flow.set(\"BME280HumidityDataPointTypeGID\", msg.payload);\n","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1410,"y":1220,"wires":[]},{"id":"c0dbf5d0.31689","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\n\n// As the BMP280 has no humidity sensor, but the BME280 does, add this option\noptions.unshift({\"Nicht zutreffend (BMP280)\": null});\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":1220,"wires":[["a77d1cff.9692d8"]]},{"id":"a31f335e.1bae2","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Pressure DPT","label":"pressure","tooltip":"","place":"Select type","group":"ef6ddc9d.4d94e","order":3,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1220,"y":1180,"wires":[["b9cbc5aa.f3442"]]},{"id":"b9cbc5aa.f3442","type":"function","z":"8f84f409.c922f8","name":"set pressure","func":"flow.set(\"BME280PressureDataPointTypeGID\", msg.payload);\n","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1410,"y":1180,"wires":[]},{"id":"e7320237.d09988","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":1180,"wires":[["a31f335e.1bae2"]]},{"id":"78c29ed.5dd54e","type":"ui_form","z":"8f84f409.c922f8","name":"Parameters","label":"","group":"ef6ddc9d.4d94e","order":5,"width":0,"height":0,"options":[{"label":"Name","value":"name","type":"text","required":true,"rows":null},{"label":"I2C address","value":"I2CAddress","type":"number","required":true,"rows":null}],"formValue":{"name":"","I2CAddress":""},"payload":"","submit":"submit","cancel":"cancel","topic":"","x":1050,"y":1300,"wires":[["fd49971a.717a4"]]},{"id":"fd49971a.717a4","type":"function","z":"8f84f409.c922f8","name":"add BME280 sensor","func":"let otherParameters = {\n  i2c_adapter: flow.get(\"BME280I2CAdapterUUID\"),\n  i2c_address: msg.payload.I2CAddress\n};\nlet dataPointTypeEdges = [\n    {\n        dataPointType: flow.get(\"BME280TemperatureDataPointTypeGID\"),\n        parameterPrefix: \"temperature\",\n    },\n    {\n        dataPointType: flow.get(\"BME280PressureDataPointTypeGID\"),\n        parameterPrefix: \"pressure\",\n    }\n];\n// Only add humidity data point type for the BME280, BMP280 does not need it\nlet humidityDataPointType = flow.get(\"BME280HumidityDataPointTypeGID\");\nif(humidityDataPointType) {\n  dataPointTypeEdges.push({\n      dataPointType: humidityDataPointType,\n      parameterPrefix: \"humidity\"\n  });\n}\nlet siteGID = flow.get(\"siteGID\");\nlet controllerComponentGID = flow.get(\"controllerComponentGID\");\n\nreturn {\n  variables: {\n    input: {\n      name: msg.payload.name,\n      site: siteGID,\n      controllerComponent: controllerComponentGID,\n      peripheralType: \"BME280\",\n      otherParameters: JSON.stringify(otherParameters),\n      dataPointTypeEdges: dataPointTypeEdges\n    },\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1720,"y":1300,"wires":[["36d3c3a4.5bb104"]]},{"id":"faddb53f.996d3","type":"ui_dropdown","z":"8f84f409.c922f8","name":"I2C Adapter","label":"","tooltip":"","place":"Select I2C adapter","group":"ef6ddc9d.4d94e","order":1,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1570,"y":1260,"wires":[["69b5d9a1.00e01"]]},{"id":"69b5d9a1.00e01","type":"function","z":"8f84f409.c922f8","name":"set I2C adapter","func":"let i2cAdapterGID = new Buffer.from(msg.payload, 'base64').toString();\nflow.set(\"BME280I2CAdapterUUID\", i2cAdapterGID.split(\":\")[1])","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1740,"y":1260,"wires":[]},{"id":"e437921.c736bf","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"let options = msg.payload.allPeripheralComponents.edges.map((i2cAdapter) => ({\n  [`${i2cAdapter.node.siteEntity.name} (${i2cAdapter.node.state})`]: i2cAdapter.node.siteEntity.id,\n}));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1410,"y":1260,"wires":[["faddb53f.996d3"]]},{"id":"f391d368.1e48c","type":"graphql","z":"8f84f409.c922f8","name":"getI2CAdapters","graphql":"7591ff8f.93ae9","format":"handlebars","syntax":"mustache","template":"query {\n  allPeripheralComponents(controllerComponent: \"{{payload}}\", peripheralType: \"I2CAdapter\") {\n    edges{\n      node{\n        siteEntity{\n          id\n          name\n        }\n        state\n      }\n    }\n  }\n}","x":1240,"y":1260,"wires":[["e437921.c736bf"],["e437921.c736bf"]]},{"id":"74ed9881.2b473","type":"function","z":"8f84f409.c922f8","name":"get I2C adapters","func":"return { payload: flow.get(\"controllerComponentGID\") };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1060,"y":1260,"wires":[["f391d368.1e48c"]]},{"id":"34d1348f.56e24c","type":"delay","z":"8f84f409.c922f8","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":915,"y":300,"wires":[["4c991ec7.e8749","8cc5faa0.2c7a2","c0dbf5d0.31689","e7320237.d09988","74ed9881.2b473","c86112af.32df5","21abe03.e1901a","39c23f6a.b7157","5b31e0d6.1f47f8","af07dd80.00899","731daa5a.e79374"]],"l":false},{"id":"816dfcf5.feb2b8","type":"ui_text","z":"8f84f409.c922f8","group":"ef6ddc9d.4d94e","order":5,"width":0,"height":0,"name":"I2C addresses","label":"I2C address is 119 (0x77) or 118 (0x76)","format":"","layout":"row-left","x":1060,"y":1340,"wires":[]},{"id":"482a3af.42178c4","type":"ui_text","z":"228a4406.83ae34","group":"4f5bcaf8.70ecd4","order":5,"width":0,"height":0,"name":"","label":"Type","format":"{{msg.payload.type}}","layout":"row-spread","x":2290,"y":280,"wires":[]},{"id":"ffbb7172.ad2b5","type":"ui_text","z":"228a4406.83ae34","group":"4f5bcaf8.70ecd4","order":5,"width":0,"height":0,"name":"","label":"Name","format":"{{msg.payload.name}}","layout":"row-spread","x":2290,"y":240,"wires":[]},{"id":"26e7ca6c.1762d6","type":"ui_text","z":"228a4406.83ae34","group":"4f5bcaf8.70ecd4","order":5,"width":0,"height":0,"name":"","label":"State","format":"{{msg.payload.state}}","layout":"row-spread","x":2290,"y":320,"wires":[]},{"id":"2fd4b6da.6c898a","type":"ui_text","z":"228a4406.83ae34","group":"4f5bcaf8.70ecd4","order":5,"width":0,"height":0,"name":"","label":"Created at","format":"{{msg.payload.createdAt}}","layout":"row-spread","x":2490,"y":400,"wires":[]},{"id":"7dd767a0.028e7","type":"ui_text","z":"228a4406.83ae34","group":"4f5bcaf8.70ecd4","order":5,"width":0,"height":0,"name":"","label":"Modified at","format":"{{msg.payload.modifiedAt}}","layout":"row-spread","x":2490,"y":440,"wires":[]},{"id":"dac5ce5b.efd7c","type":"function","z":"228a4406.83ae34","name":"to text","func":"let controller_msg = {};\nlet options = msg.payload.allDataPointTypes.edges.map((edge) => ({\n[`${edge.node.name} in ${edge.node.unit}`]: edge.node.id,\n}));\n\nreturn {\n    payload: {\n        name: msg.payload.siteEntity.name,\n        type: msg.payload.siteEntity.peripheralComponent.peripheralType,\n        state: msg.payload.siteEntity.peripheralComponent.state,\n        otherParameters: msg.payload.siteEntity.peripheralComponent.otherParameters,\n        createdAt: msg.payload.siteEntity.peripheralComponent.createdAt,\n        modifiedAt: msg.payload.siteEntity.peripheralComponent.modifiedAt\n    }\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2150,"y":240,"wires":[["ffbb7172.ad2b5","482a3af.42178c4","26e7ca6c.1762d6","f7df592.2eee5a8","64872c02.0e1a14","1928bbd9.2ae774"]],"outputLabels":["controller SE"]},{"id":"f7df592.2eee5a8","type":"moment","z":"228a4406.83ae34","name":"Format date","topic":"","input":"payload.createdAt","inputType":"msg","inTz":"Africa/Abidjan","adjAmount":0,"adjType":"days","adjDir":"add","format":"hh:mm D/MM/YY","locale":"de-DE","output":"payload.createdAt","outputType":"msg","outTz":"Europe/Berlin","x":2310,"y":400,"wires":[["2fd4b6da.6c898a"]]},{"id":"64872c02.0e1a14","type":"moment","z":"228a4406.83ae34","name":"Format date","topic":"","input":"payload.modifiedAt","inputType":"msg","inTz":"Africa/Abidjan","adjAmount":0,"adjType":"days","adjDir":"add","format":"hh:mm D/MM/YY","locale":"de-DE","output":"payload.modifiedAt","outputType":"msg","outTz":"Europe/Berlin","x":2310,"y":440,"wires":[["7dd767a0.028e7"]]},{"id":"ffb9d6ad.a5ea98","type":"ui_text","z":"228a4406.83ae34","group":"75be1027.4dcde","order":2,"width":0,"height":0,"name":"Sample data","label":"Sample data in Demo BME280 - A","format":"","layout":"row-spread","x":1670,"y":480,"wires":[]},{"id":"96804692.ad2498","type":"ui_ui_control","z":"b3f3ed44.15c7f8","name":"","events":"all","x":1000,"y":220,"wires":[[]]},{"id":"d608a36.19e4ae","type":"comment","z":"b3f3ed44.15c7f8","name":"Set value task","info":"","x":1070,"y":260,"wires":[]},{"id":"2ff43a98.050c6e","type":"comment","z":"b3f3ed44.15c7f8","name":"Poll sensor task","info":"","x":1080,"y":400,"wires":[]},{"id":"273a7bd8.3039d4","type":"delay","z":"b3f3ed44.15c7f8","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":955,"y":260,"wires":[["124d2f44.3dec21"]],"l":false},{"id":"cbc2bc1e.45316","type":"function","z":"b3f3ed44.15c7f8","name":"set dataPointTypes","func":"let dataPointTypes = [];\ntry {\n  dataPointTypes = msg.payload.siteEntity.peripheralComponent.dataPointTypeSet.edges.map(\n    (edge) => edge.node\n  );\n} catch (err) {\n  dataPointTypes = [{ name: \"None\", unit: \"N/A\", id: \"\" }];\n}\nflow.set(\"dataPointTypes\", dataPointTypes);\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":930,"y":180,"wires":[["f1bd403d.1ea2e8"]]},{"id":"d2a6c8d0.5ab36","type":"function","z":"228a4406.83ae34","name":"set controllerName","func":"flow.set(\"controllerName\", msg.payload);","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1690,"y":120,"wires":[]},{"id":"1735ac52.19167c","type":"ui_text","z":"b3f3ed44.15c7f8","group":"1b3eb2f8.827855","order":1,"width":0,"height":0,"name":"","label":"Controller:","format":"{{msg.payload.controllerName}}","layout":"row-spread","x":270,"y":180,"wires":[]},{"id":"efea4603.8455e8","type":"ui_dropdown","z":"b3f3ed44.15c7f8","name":"","label":"","tooltip":"","place":"Select option","group":"13943af0.22d85d","order":2,"width":0,"height":0,"passthru":true,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1220,"y":300,"wires":[["1ff6be93.ec8899"]]},{"id":"124d2f44.3dec21","type":"function","z":"b3f3ed44.15c7f8","name":"to dropdown","func":"let options = flow.get(\"dataPointTypes\").map(\n  (dataPointType) => ({[`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id})\n);\n\nlet firstValue = Object.values(options[0])[0];\nreturn { options: options, payload: firstValue };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1070,"y":300,"wires":[["efea4603.8455e8"]]},{"id":"1ff6be93.ec8899","type":"function","z":"b3f3ed44.15c7f8","name":"set setValueDataPointTypeGID","func":"flow.set(\"setValueDataPointTypeGID\", msg.payload);\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1430,"y":300,"wires":[[]]},{"id":"2e957d4f.5c771a","type":"function","z":"b3f3ed44.15c7f8","name":"start task","func":"parameters = {};\n// Set the peripheral UUID\nconst peripheralGID = new Buffer(\n  flow.get(\"peripheral\").peripheralGID,\n  \"base64\"\n);\nparameters[\"peripheral\"] = peripheralGID.toString().split(\":\")[1];\n// Set the interval\nparameters[\"interval_ms\"] = msg.payload.interval_s * 1000;\n\n// Get all relevant variables\nlet variables = {\n  input: {\n    controllerComponent: flow.get(\"controllerComponentGID\"),\n    taskType: flow.get(\"taskType\"),\n    parameters: JSON.stringify(parameters),\n  },\n};\n// If a timeout is specified, add the run_until datetime\nif (msg.payload.duration_s) {\n  let runUntil = new Date(Date.now() + msg.payload.duration_s*1000);\n  variables.input.runUntil = runUntil.toISOString();\n}\n\nreturn {variables: variables};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1500,"y":440,"wires":[["ff77b3e1.054d8"]]},{"id":"66bb7cc5.ea1264","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Digital In input type","label":"","tooltip":"","place":"Select input type","group":"49fdd85e.8fcd3","order":2,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"Floating (default)","value":"floating","type":"str"},{"label":"Pullup","value":"pullup","type":"str"},{"label":"Pulldown","value":"pulldown","type":"str"}],"payload":"","topic":"","x":1070,"y":380,"wires":[["bdfc4ce4.da7728"]]},{"id":"bdfc4ce4.da7728","type":"function","z":"8f84f409.c922f8","name":"set digitalInInputType","func":"flow.set(\"digitalInInputType\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1280,"y":380,"wires":[]},{"id":"739d8bf6.e69c44","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Digital Out DPT","label":"","tooltip":"","place":"Select on/off type","group":"2c52902d.e1ac68","order":1,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1220,"y":500,"wires":[["39cbbe1d.7b87b2"]]},{"id":"39cbbe1d.7b87b2","type":"function","z":"8f84f409.c922f8","name":"set digitalOutDataPointTypeGID","func":"flow.set(\"digitalOutDataPointTypeGID\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1450,"y":500,"wires":[]},{"id":"c86112af.32df5","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":500,"wires":[["739d8bf6.e69c44"]]},{"id":"7dc5b97a.307ef","type":"ui_form","z":"8f84f409.c922f8","name":"Parameters","label":"","group":"2c52902d.e1ac68","order":3,"width":0,"height":0,"options":[{"label":"Name","value":"name","type":"text","required":true,"rows":null},{"label":"Pin #","value":"pin","type":"number","required":true,"rows":null}],"formValue":{"name":"","pin":""},"payload":"","submit":"create","cancel":"clear","topic":"","x":1050,"y":540,"wires":[["a13cfdd6.2e98b8"]]},{"id":"5c2e8b3d.4eb4ec","type":"comment","z":"8f84f409.c922f8","name":"Add DigitalOut peripheral","info":"","x":1090,"y":460,"wires":[]},{"id":"a13cfdd6.2e98b8","type":"function","z":"8f84f409.c922f8","name":"add digital out peripheral","func":"// Other parameters have to use snake case\nlet otherParameters = {\n  pin: msg.payload.pin,\n};\n\nlet siteGID = flow.get(\"siteGID\");\nlet controllerComponentGID = flow.get(\"controllerComponentGID\");\nlet digitalOutDataPointTypeGID = flow.get(\"digitalOutDataPointTypeGID\");\n\nreturn {\n  variables: {\n    input: {\n      name: msg.payload.name,\n      site: siteGID,\n      controllerComponent: controllerComponentGID,\n      peripheralType: \"DigitalOut\",\n      otherParameters: JSON.stringify(otherParameters),\n      dataPointTypeEdges: [\n        {\n          dataPointType: digitalOutDataPointTypeGID,\n          parameterPrefix: \"\",\n        },\n      ],\n    },\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":540,"wires":[["36d3c3a4.5bb104"]]},{"id":"e1bc0097.e374d8","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Analog In Percent DPT","label":"","tooltip":"","place":"Select percent type","group":"89c84b8c.3c997","order":3,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1240,"y":620,"wires":[["5980b719.a34f58"]]},{"id":"5980b719.a34f58","type":"function","z":"8f84f409.c922f8","name":"set analogInPercentDataPointTypeGID","func":"flow.set(\"analogInPercentDataPointTypeGID\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1510,"y":620,"wires":[]},{"id":"21abe03.e1901a","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nflow.set(\"analogInPercentDataPointTypeGID\", undefined);\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":620,"wires":[["e1bc0097.e374d8"]]},{"id":"2200a311.8d4574","type":"ui_form","z":"8f84f409.c922f8","name":"Parameters","label":"","group":"89c84b8c.3c997","order":5,"width":0,"height":0,"options":[{"label":"Name","value":"name","type":"text","required":true,"rows":null},{"label":"Pin #","value":"pin","type":"number","required":true,"rows":null}],"formValue":{"name":"","pin":""},"payload":"","submit":"create","cancel":"clear","topic":"","x":1050,"y":700,"wires":[["759ed7ab.5e7ab8"]]},{"id":"1fba820b.75035e","type":"comment","z":"8f84f409.c922f8","name":"Add AnalogIn peripheral","info":"","x":1080,"y":580,"wires":[]},{"id":"759ed7ab.5e7ab8","type":"function","z":"8f84f409.c922f8","name":"add analog in peripheral","func":"// Other parameters have to use snake case\nlet otherParameters = {\n  pin: msg.payload.pin,\n};\n\nlet siteGID = flow.get(\"siteGID\");\nlet controllerComponentGID = flow.get(\"controllerComponentGID\");\nlet analogInPercentDataPointTypeGID = flow.get(\n  \"analogInPercentDataPointTypeGID\"\n);\nlet analogInVoltageDataPointTypeGID = flow.get(\n  \"analogInVoltageDataPointTypeGID\"\n);\n\nif (!analogInPercentDataPointTypeGID && !analogInVoltageDataPointTypeGID) {\n  node.error(\"No data point type selected\", msg);\n  return;\n}\ndataPointTypeEdges = [];\nif (analogInPercentDataPointTypeGID) {\n  dataPointTypeEdges.push({\n    dataPointType: analogInPercentDataPointTypeGID,\n    parameterPrefix: \"percent\",\n  });\n}\nif (analogInVoltageDataPointTypeGID) {\n  dataPointTypeEdges.push({\n    dataPointType: analogInVoltageDataPointTypeGID,\n    parameterPrefix: \"voltage\",\n  });\n}\n\nreturn {\n  variables: {\n    input: {\n      name: msg.payload.name,\n      site: siteGID,\n      controllerComponent: controllerComponentGID,\n      peripheralType: \"AnalogIn\",\n      otherParameters: JSON.stringify(otherParameters),\n      dataPointTypeEdges: dataPointTypeEdges,\n    },\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":700,"wires":[["36d3c3a4.5bb104"]]},{"id":"59729904.18d098","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Analog Out Percent DPT","label":"","tooltip":"","place":"Select percent type","group":"3585ca71.4c9306","order":2,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1250,"y":780,"wires":[["122a6c6e.01936c"]]},{"id":"122a6c6e.01936c","type":"function","z":"8f84f409.c922f8","name":"set analogOutPercentDataPointTypeGID","func":"flow.set(\"analogOutPercentDataPointTypeGID\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1540,"y":780,"wires":[]},{"id":"39c23f6a.b7157","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":780,"wires":[["59729904.18d098"]]},{"id":"62cb6c67.abd984","type":"ui_form","z":"8f84f409.c922f8","name":"Parameters","label":"","group":"3585ca71.4c9306","order":4,"width":0,"height":0,"options":[{"label":"Name","value":"name","type":"text","required":true,"rows":null},{"label":"Pin #","value":"pin","type":"number","required":true,"rows":null}],"formValue":{"name":"","pin":""},"payload":"","submit":"create","cancel":"clear","topic":"","x":1050,"y":860,"wires":[["d84583d5.b236f8"]]},{"id":"ed034961.68f92","type":"comment","z":"8f84f409.c922f8","name":"Add AnalogOut peripheral","info":"","x":1090,"y":740,"wires":[]},{"id":"d84583d5.b236f8","type":"function","z":"8f84f409.c922f8","name":"add analog out peripheral","func":"// Other parameters have to use snake case\nlet otherParameters = {\n  pin: msg.payload.pin,\n};\n\nlet siteGID = flow.get(\"siteGID\");\nlet controllerComponentGID = flow.get(\"controllerComponentGID\");\nlet analogOutPercentDataPointTypeGID = flow.get(\"analogOutPercentDataPointTypeGID\");\nlet analogOutVoltageDataPointTypeGID = flow.get(\"analogOutVoltageDataPointTypeGID\");\n\nlet dataPointTypeEdges = []\n\nreturn {\n  variables: {\n    input: {\n      name: msg.payload.name,\n      site: siteGID,\n      controllerComponent: controllerComponentGID,\n      peripheralType: \"AnalogOut\",\n      otherParameters: JSON.stringify(otherParameters),\n      dataPointTypeEdges: [\n        {\n          dataPointType: analogOutDataPointTypeGID,\n          parameterPrefix: \"\",\n        },\n      ],\n    },\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1710,"y":860,"wires":[["36d3c3a4.5bb104"]]},{"id":"d999c13b.4e733","type":"ui_dropdown","z":"8f84f409.c922f8","name":"PWM DPT","label":"","tooltip":"","place":"Select PWM type","group":"56dd7bf5.801f1c","order":1,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1210,"y":940,"wires":[["26d92332.f450cc"]]},{"id":"26d92332.f450cc","type":"function","z":"8f84f409.c922f8","name":"set PWMDataPointTypeGID","func":"flow.set(\"PWMDataPointTypeGID\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1440,"y":940,"wires":[]},{"id":"731daa5a.e79374","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":940,"wires":[["d999c13b.4e733"]]},{"id":"b37acb81.6bcaf8","type":"ui_form","z":"8f84f409.c922f8","name":"Parameters","label":"","group":"56dd7bf5.801f1c","order":3,"width":0,"height":0,"options":[{"label":"Name","value":"name","type":"text","required":true,"rows":null},{"label":"Pin #","value":"pin","type":"number","required":true,"rows":null}],"formValue":{"name":"","pin":""},"payload":"","submit":"create","cancel":"clear","topic":"","x":1050,"y":980,"wires":[["8148bb8.5aacd48"]]},{"id":"7b89bbed.abe05c","type":"comment","z":"8f84f409.c922f8","name":"Add PWM peripheral","info":"","x":1070,"y":900,"wires":[]},{"id":"8148bb8.5aacd48","type":"function","z":"8f84f409.c922f8","name":"add PWM peripheral","func":"// Other parameters have to use snake case\nlet otherParameters = {\n  pin: msg.payload.pin,\n};\n\nlet siteGID = flow.get(\"siteGID\");\nlet controllerComponentGID = flow.get(\"controllerComponentGID\");\nlet PWMDataPointTypeGID = flow.get(\"PWMDataPointTypeGID\");\n\nreturn {\n  variables: {\n    input: {\n      name: msg.payload.name,\n      site: siteGID,\n      controllerComponent: controllerComponentGID,\n      peripheralType: \"PWM\",\n      otherParameters: JSON.stringify(otherParameters),\n      dataPointTypeEdges: [\n        {\n          dataPointType: PWMDataPointTypeGID,\n          parameterPrefix: \"\",\n        },\n      ],\n    },\n  },\n};\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1720,"y":980,"wires":[["36d3c3a4.5bb104"]]},{"id":"a30c125d.a29288","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Analog In Voltage DPT","label":"","tooltip":"","place":"Select voltage type","group":"89c84b8c.3c997","order":4,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1240,"y":660,"wires":[["d86f6e75.4b8758"]]},{"id":"d86f6e75.4b8758","type":"function","z":"8f84f409.c922f8","name":"set analogInVoltageDataPointTypeGID","func":"flow.set(\"analogInVoltageDataPointTypeGID\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1510,"y":660,"wires":[]},{"id":"5b31e0d6.1f47f8","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nflow.set(\"analogInVoltageDataPointTypeGID\", undefined);\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":660,"wires":[["a30c125d.a29288"]]},{"id":"ba247cd7.b0749","type":"ui_text","z":"8f84f409.c922f8","group":"89c84b8c.3c997","order":1,"width":"3","height":"1","name":"","label":"Select one or both types","format":"","layout":"row-spread","x":810,"y":620,"wires":[]},{"id":"7f41557.012e82c","type":"ui_button","z":"8f84f409.c922f8","name":"","group":"89c84b8c.3c997","order":2,"width":"3","height":"1","passthru":false,"label":"Clear","tooltip":"","color":"","bgcolor":"gray","icon":"","payload":"","payloadType":"str","topic":"","x":870,"y":660,"wires":[["21abe03.e1901a","5b31e0d6.1f47f8"]]},{"id":"f34c640e.2fdfa8","type":"ui_dropdown","z":"8f84f409.c922f8","name":"Analog Out Voltage DPT","label":"","tooltip":"","place":"Select voltage type","group":"3585ca71.4c9306","order":3,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"","x":1250,"y":820,"wires":[["98cc0099.47ffb8"]]},{"id":"98cc0099.47ffb8","type":"function","z":"8f84f409.c922f8","name":"set analogOutVoltageDataPointTypeGID","func":"flow.set(\"analogOutVoltageDataPointTypeGID\", msg.payload)","outputs":0,"noerr":0,"initialize":"","finalize":"","x":1540,"y":820,"wires":[]},{"id":"af07dd80.00899","type":"function","z":"8f84f409.c922f8","name":"to dropdown","func":"// Store peripheral as {peripheralName: \"some name\", peripheralGID: \"peripheral GID\"}\nlet options = flow.get(\"dataPointTypes\").map((dataPointType) => ({\n  [`${dataPointType.name} in ${dataPointType.unit}`]: dataPointType.id,\n}));\nreturn { options: options };\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1050,"y":820,"wires":[["f34c640e.2fdfa8"]]},{"id":"86542d13.411ce8","type":"ui_text","z":"8f84f409.c922f8","group":"3585ca71.4c9306","order":1,"width":"3","height":"1","name":"","label":"Select one type","format":"","layout":"row-spread","x":840,"y":780,"wires":[]},{"id":"16aae19a.445eae","type":"ui_button","z":"8f84f409.c922f8","name":"","group":"3585ca71.4c9306","order":2,"width":"3","height":"1","passthru":false,"label":"Clear","tooltip":"","color":"","bgcolor":"gray","icon":"","payload":"","payloadType":"str","topic":"","x":870,"y":820,"wires":[["af07dd80.00899","39c23f6a.b7157"]]},{"id":"1928bbd9.2ae774","type":"ui_text","z":"228a4406.83ae34","group":"4f5bcaf8.70ecd4","order":5,"width":0,"height":0,"name":"","label":"Other parameters","format":"{{msg.payload.otherParameters}}","layout":"row-spread","x":2330,"y":360,"wires":[]}]